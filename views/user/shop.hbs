<div class="advanced-filter">
    <div class="dropdown display-inline">
        <input type="search" id="search"  class="search-input" placeholder="Tìm kiếm sản phẩm" value="{{search}}">
        <a id="find" href=#""><button class="search-button"><img src="/images/search.png" class="filter-img"></button></a>
        <button class="btn btn-secondary dropdown-toggle price-select-btn" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Sắp xếp sách
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item" href="#" id="price-increase">Giá tăng dần</a>
            <a class="dropdown-item" href="#" id = "price-decrease">Giá giảm dần</a>
        </div>
    </div>
    <button class="button-filter" id="filter-button"><img src="/images/filter.png" class="filter-img"></button>

</div>
<br>
<div class="collapse-filter" id="filter-info">
    <div class="container filter-info-container">
        <div class="row">
            <div class="col">
                <h3>Giá tiền</h3>
                <div>
                    <input type="radio" class="filter-elements display-inline" name="price" id="lt100">
                    <label for="lt100"> <100.000đ</label>
                </div>
                <div>
                    <input type="radio" class="filter-elements display-inline" name="price" id="gte100">
                    <label for="gte100">≥ 100.000đ</label>
                </div>
            </div>

            <div class="col">
                <h3>Thể loại</h3>
                <div>
                    <input type="radio" class="filter-elements display-inline" name="theloai" id="vanhoc">
                    <label for="vanhoc">Văn học</label>
                </div>
                <div>
                    <input type="radio" class="filter-elements display-inline" name="theloai" id="tieuthuyet">
                    <label for="tieuthuyet">Tiểu thuyết</label>
                </div>
                <div>
                    <input type="radio" class="filter-elements display-inline" name="theloai" id="tutruyen">
                    <label for="tutruyen">Tự truyện</label>
                </div>
            </div>

            <div class="col">
                <h3>Ngôn ngữ</h3>
                <div>
                    <input type="radio" class="filter-elements display-inline" name="ngonngu" id="tiengviet">
                    <label for="vanhoc">Tiếng Việt</label>
                </div>
                <div>
                    <input type="radio" class="filter-elements display-inline" name="ngonngu" id="ngoaingu">
                    <label for="tieuthuyet">Ngoại ngữ</label>
                </div>
            </div>
        </div>
        <div class="row">
            <a href="#" class="center-submit" id="find-filter"><button class="submit-decoration" id="find-filter-btn">Tìm kiếm</button></a>
        </div>
       
    </div>
</div>
<br>
<div class="container shop-container" id="xxxx">
    <div class="row">
        <div class="col-3" >
            <section>
                <div class="accordion" id="accordionExample">
                    <div class="see-all-books-container"> 
                        <p class="favorite-book-align see-all-books"><a href="/shop?page=1" class="see-all-books">XEM TẤT CẢ SÁCH</a></p>
                    </div>
                    <div class="card">
                        <div class="card-header filter-container" id="headingOne">
                        <h2 class="mb-0">
                            <button class="btn btn-lin collapsed filter filter-title" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            THỂ LOẠI SÁCH
                            </button>
                        </h2>
                        </div>

                        <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
                            <div class="card-body">
                                <ul class="filter-list">
                                    <a href="/shop/type=VanHoc?page=1" class="type-book-title"><li class="filter-elements">VĂN HỌC</li></a>
                                    <a href="/shop/type=TieuThuyet?page=1" class="type-book-title"><li class="filter-elements">TIỂU THUYẾT</li></a>
                                    <a href="/shop/type=TuTruyen?page=1" class="type-book-title"><li class="filter-elements">TỰ TRUYỆN</li></a>
                                </ul> 
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header filter-container" id="headingTwo">
                        <h2 class="mb-0">
                            <button class="btn btn-lin collapsed filter filter-title" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            NGÔN NGỮ
                            </button>
                        </h2>
                        </div>
                        <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
                        <div class="card-body">
                            <ul class="filter-list">
                                <a href="/shop/lang=Vietnamese?page=1" class="type-book-title"><li class="filter-elements">TIẾNG VIỆT</li></a>
                                <a href="/shop/lang=Foreign?page=1" class="type-book-title"><li class="filter-elements">NGOẠI NGỮ</li></a>
                            </ul>
                        </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header filter-container" id="headingThree">
                        <h2 class="mb-0">
                            <button class="btn btn-lin collapsed filter filter-title" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            NHÀ XUẤT BẢN
                            </button>
                        </h2>
                        </div>
                        <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
                        <div class="card-body">
                            <ul class="filter-list">
                                <a href="/shop/publisher=NXB-NhaNam?page=1" class="type-book-title"><li class="filter-elements">NHÃ NAM</li></a>
                                <a href="/shop/publisher=NXB-TriThuc?page=1" class="type-book-title"><li class="filter-elements">NXB TRI THỨC</li></a>
                                <a href="/shop/publisher=NXB-Tre?page=1" class="type-book-title"><li class="filter-elements">NXB TRẺ</li></a>
                                <a href="/shop/publisher=NXB-TheGioi?page=1" class="type-book-title"><li class="filter-elements">NXB THẾ GIỚI</li></a>
                                <a href="/shop/publisher=NXB-HNV?page=1" class="type-book-title"><li class="filter-elements">NXB HỘI NHÀ VĂN</li></a>
                                <a href="/shop/publisher=NXB-TH?page=1" class="type-book-title"><li class="filter-elements">NXB TỔNG HỢP TP.HCM</li></a>
                                <a href="/shop/publisher=NXB-LaoDong?page=1" class="type-book-title"><li class="filter-elements">NXB LAO ĐỘNG</li></a>   
                            </ul>
                        </div>
                        </div>
                    </div>
                    
                </div>
            </section>
        </div>
        <div class="col">  
            <div class="d-flex flex-sm-wrap">
                {{#each danhsach.rows}}
                <div class="p-2 bd-highlight book-container">
                    <a href="/shop/product/id={{this.BookID}}?page=1"><img src="/images/{{this.bookimg}}" alt="{{this.BookID}}-img"></a>
                    <a href="/shop/product/id={{this.BookID}}?page=1" class="book-title"><h5 class="favorite-book-align shop-book-title" >{{this.BookName}}</h5></a>
                    <p class="favorite-book-align">{{this.Author}}</p>
                    <h6 class="favorite-book-align">
                        <span class="price-style">{{this.Price}} đ</span> / <a href="/shop/product/id={{this.BookID}}?page=1" class="buy-now" >Mua ngay</a>
                    </h6>                   
                   
                </div>
                {{/each}}
            </div>
            <br>
            <nav aria-label="Page navigation example" class="display-pages">
                <ul class="pagination" id="pages">
                </ul>
            </nav>
        </div>
    </div>
</div>
<script>
    (function()
    {   
        const pages = {{numbersOfPages}};
        let href = window.location.pathname + "?page=";      
        let sort = "";
        let find = "";
        let search = "";
        let indexOfSearch = -1;
        let indexOfSort = -1;
        indexOfSearch = window.location.href.indexOf("&search");
        indexOfSort = window.location.href.indexOf("&sort");

        if(window.location.href.includes('find'))
        {
            const substr = window.location.href.indexOf('&');
            let index = -1;
            if(indexOfSearch !== -1 && indexOfSort !== -1)
            {
                index =indexOfSearch > indexOfSort ?  indexOfSort : indexOfSearch;
                find = window.location.href.substring(substr,index);  
            }
            else if (indexOfSearch > 0 && indexOfSort === -1)
            {
                find = window.location.href.substring(substr,indexOfSearch);  
            }
            else if (indexOfSort > 0 && indexOfSearch === -1)
            {
                find = window.location.href.substring(substr,indexOfSort);                
            }
            else find = window.location.href.substring(substr);  
        }
     
        if(indexOfSearch !== -1)
        {
            if(indexOfSort > indexOfSearch)
            {
                search= window.location.href.substring(indexOfSearch,indexOfSort);
            }
            else search= window.location.href.substring(indexOfSearch);
        }
        if(window.location.href.includes('sort=asc'))
        {
            sort ="&sort=asc"
        }
        if(window.location.href.includes('sort=desc'))
        {
            sort ="&sort=desc"
        }
       
        for(let i = 1 ; i <= pages ; i++)
        {
            const ul = document.getElementById('pages');
            const li = document.createElement("li");
            const a = document.createElement("a");
            a.appendChild(document.createTextNode(i));
            a.setAttribute("class","page-link");
            a.setAttribute("href",href+i.toString()+find+search+sort);
            li.appendChild(a);
            li.setAttribute("class", "page-item");
            ul.appendChild(li);
        }

        //tạo đường link cho href của sắp xếp theo giá
        document.getElementById('price-increase').href = window.location.href.includes('sort=desc')? window.location.href.replace('sort=desc','sort=asc') : window.location.href.includes('sort=asc')? window.location.href+'#' : window.location.href + '&sort=asc';
        document.getElementById('price-decrease').href = window.location.href.includes('sort=asc')? window.location.href.replace('sort=asc','sort=desc') : window.location.href.includes('sort=desc')? window.location.href+'#' : window.location.href + '&sort=desc';

    })();

    function showFilter(){
        const filter= document.getElementById('filter-info');
        if(filter.style.display === "none")
        {
            filter.style.display ="block";
        }
        else{
            filter.style.display = "none";
        }
    }

    document.getElementById('filter-button').onclick = showFilter;

    function getPriceCheck(){
        if(document.getElementById('lt100').checked)
        {
            return 'lt100';
        }
        else if(document.getElementById('gte100').checked)
        {
            return 'gte100';
        }
        return '';
    }

    function getTypeCheck(){
        if(document.getElementById('vanhoc').checked)
        {
            return 'vanhoc';
        }
        else if(document.getElementById('tieuthuyet').checked)
        {
            return 'tieuthuyet';
        }
         else if(document.getElementById('tutruyen').checked)
        {
            return 'tutruyen';
        }
        return '';
    }

    function getLangCheck(){
        if(document.getElementById('tiengviet').checked)
        {
            return 'tiengviet';
        }
        else if(document.getElementById('ngoaingu').checked)
        {
            return 'ngoaingu';
        }
        return '';
    }

    function findFilter(){
        const priceCheck = getPriceCheck();
        const typeCheck = getTypeCheck(); 
        const langCheck = getLangCheck();
        if(priceCheck === '' && typeCheck === '' && langCheck === '')
        {
            return;
        }
        document.getElementById('find-filter').href = '/shop/find?page=1&gia='+ priceCheck +'&theloai=' + typeCheck + '&lang=' + langCheck;
    }

    document.getElementById('find-filter-btn').onclick = findFilter;

    function search(){
        let searchValue = document.getElementById('search').value;
        
        for(let i = 0 ;i< searchValue.length; i++)
        {
            if(searchValue[i] === ' ')
            {
                searchValue = searchValue.replace(searchValue[i],'+');
            }
        }
        searchValue = "&search=" + searchValue;
        let href = window.location.href
        const firstIndex = href.indexOf("page");
        let lastIndex;
        let i = firstIndex;

        for( i ; ; i++)
        { 
            if(href[i] === '&') 
            {
                break;
            }
            if(href[i] === undefined)
            {
                break;
            }

            lastIndex=i;
        }
        lastIndex++;
        const str = href.substring(firstIndex,lastIndex);
       
        href = href.replace(str,"page=1");
        
        if(href.includes("&search"))
        {
            const indexOfSearch = href.indexOf("&search");
            const searchString = href.substring(indexOfSearch);
            href = href.replace(searchString,"");
        }
        href += searchValue;
        document.getElementById('find').href = href;
    }

    document.getElementById('find').onclick = search;
</script>

